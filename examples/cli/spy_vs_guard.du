include("colors.du")

print("""
Spy vs Guard: A High-Stakes Encounter
=====================================

""")

// Initialize the nervous spy
spy = conversation(system = """
You are a nervous secret agent. Your codename is Shadow, but your cover is Bob, a researcher at ACME Products.
You MUST escape this facility without blowing your cover. Your goal is to get past the security guard and walk away.
Only when you have successfully passed the guard and are walking away to freedom, end with "THE END" on a new line.
Respond with 1-2 sentences only. Minimal stage directions. Sound natural like real dialogue. Stay in character!
""",
model = "claude-haiku-4-5-20251001",
tokens = 256)

// Initialize the dim-witted security guard
guard = conversation(system = """
You are a dim-witted security guard at ACME Products. You're bored out of your mind and want to feel important.
Your supervisor has been riding you about not doing thorough checks, so you're trying to look busy and competent.
You ask questions and chat just to seem like you're doing your job, even if the person seems legitimate.
Only if you become genuinely suspicious will you sound the alarm with witty commentary and end with "THE END" on a new line.
Respond with 1-2 sentences only. Minimal stage directions. Sound natural like real dialogue. Stay in character!
""",
model = "claude-haiku-4-5-20251001",
tokens = 256)

// Helper function to check if response ends with "THE END"
function is_story_end(response)
    trimmed = trim(response)
    if len(trimmed) >= 7 then
        last_line = split(trimmed, "\n")
        last_line = last_line[len(last_line) - 1]
        return trim(last_line) == "THE END"
    end
    return false
end

// Start the encounter
turn = 0
max_turns = 20
story_over = false
spy_prompt = "You're approaching the security checkpoint at the facility exit."
guard_prompt = "Someone is approaching your security checkpoint."

while turn < max_turns and not story_over do
    turn = turn + 1

    print(green + "\n[Turn {{turn}}]" + reset)

    // Spy acts
    spy_response = spy.prompt(spy_prompt)
    print(yellow + "\nSpy (Bob): " + reset + spy_response)

    if is_story_end(spy_response) then
        story_over = true
        break
    end

    // Guard reacts
    guard_prompt = spy_response
    guard_response = guard.prompt(guard_prompt)
    print(cyan + "\nGuard: " + reset + guard_response)

    if is_story_end(guard_response) then
        story_over = true
        break
    end

    // Update spy prompt for next turn
    spy_prompt = guard_response
end

print(green + "\n\n=== STORY COMPLETE ===" + reset)
